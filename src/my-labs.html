<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="my-labs">

  <template>

    <style include="shared-styles"></style> 
    <style>
      :host {
        display: block;
        padding: 10px;
      }
      .card {
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        padding: 16px;
        margin: 24px;
        border-radius: 5px;
        background-color: #fff;
        color: #757575;
         display: flex;
        justify-content: center;
        overflow: hidden;
        margin: 0;
      }
      .circle {
        display: inline-block;
        height: 64px;
        width: 64px;
        border-radius: 50%;
        background: #ddd;
        line-height: 64px;
        font-size: 30px;
        color: #555;
        text-align: center;
      }
      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      h3{
        font-family: roboto-thin;
      }

      /*  HEART CHECKBOX */      
      [type='checkbox'] + label {
        align-self: center;
        position: relative;
        color: darkgrey;
        font-size: 2em;
        cursor: pointer;
      }
      [type='checkbox']:checked + label {
        will-change: font-size;
        animation: heart 1s cubic-bezier(0.17, 0.89, 0.32, 1.49);
      }
      [type='checkbox']:checked.red  + label {
        color: #e2264d;
      }
      [type='checkbox']:checked.yellow  + label {
        color: #D1A616;
      }
      [type='checkbox']:checked.green  + label {
        color: #00FF00;
      }

      @keyframes heart {
        0%, 10% {
          font-size: 0;
        }
      }

      /* Dynamic bg */
      #canvas {
        position: absolute;
        top: 124px;
        left: 0;
        right: 0;
      }

      /*Blob bg*/
      #canvas-two{
        position: absolute;
        -webkit-filter: url("#goo");
        filter: url("#goo");
      }
    </style>
    
    <div class="container">
      <div class="section">
        <div class="row">
          <div class="card">
            <div class="row">
              <div class="col s12 center">
                  <h3 >About this site</h3>              
              </div>
              <div class="col s12 m8 offset-m2">
                    <span style="font-family:roboto-thin; margin-left: auto;left: auto;right: auto;float: left;">
                      You're experiencing a <a href="https://developers.google.com/web/progressive-web-apps/" style="padding: 0px;display: inline;line-height: normal;">Progressive Web App</a> built with Polymer 1.0. 
                      <br><br>
                      Progressive Web Applications take advantage of new technologies to bring the best of mobile sites and native applications to users. They're reliable, fast, and engaging so you may have instant:
                      <br>
                      <br>                  
                      - Component-based architecture using Polymer and web components.
                      <br>
                      - Responsive design using the app layout components.
                      <br>
                      - End-to-end Build Tooling (including Vulcanize)
                      <br>
                      - Unit testing with Web Component Tester
                      <br>
                      - Localization with app-localize-behavior.
                      <br>
                      - Turnkey support for local storage with app storage elements.
                      <br>
                      - Modular routing using the app-route elements.
                      <br>
                      - Offline caching as a progressive enhancement, using Platinum Service Worker Elements
                      <br>
                      - Super portable UI to Android and iOS using Cordova
                      <br>
                      - Build tooling to support serving your app unbundled for delivery over HTTP/2 with server push
                      <br>
                      - Build tooling to support serving your app bundled for delivery over HTTP/1
                    </span>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="card">
            <div class="row">
              <div class="col s12 center">
                <h3 >Shaped, animated checkboxes</h3>              
              </div>
              <div class="col s4 center" style="padding-top:12px">
                <input id="toggle" type="checkbox" class="red" />
                <label for="toggle">❤</label>
              </div>
              <div class="col s4 center" style="padding-top:12px">
                <input id="toggle1" type="checkbox" class="yellow" />
                <label for="toggle1">★</label>
              </div>
              <div class="col s4 center" style="padding-top:12px">
                <input id="toggle2" type="checkbox" class="green" />
                <label for="toggle2">☯</label>
              </div>
              <div class="col s4 center" style="padding-top:12px">
                <input id="toggle3" type="checkbox" class="red" />
                <label for="toggle3">☀</label>
              </div>
              <div class="col s4 center" style="padding-top:12px">
                <input id="toggle4" type="checkbox" class="yellow" />
                <label for="toggle4">☺</label>
              </div>
              <div class="col s4 center" style="padding-top:12px">
                <input id="toggle5" type="checkbox" class="green" />
                <label for="toggle5">✿</label>
              </div>
            </div>
          </div>
        </div>   
        <div class="row">
          <div class="card" style="height:40vh; position: relative">
            <div class="col s12 center">
                <h3 >Spawn background</h3>              
            </div>
            <div class="row">
            <canvas id="canvas"></canvas>
            </div>
          </div>
        </div> 
        <div class="row">
          <div class="card" style="min-height:40vh; position: relative">
            <div class="col s12 center">
                <h3 >Google NLP API</h3>              
                <div class="row">
                    <div class="input-field col s12">
                        <paper-textarea id="nlp_input" label="Click submit or try your own text to see its magic!" value="Google, headquartered in Mountain View, unveiled the new Android phone at the Consumer Electronic Show.  Sundar Pichai said in his keynote that users love their new Android phones"></paper-textarea>
                      <div class="input-field col s12">
                            <a class="waves-effect waves-light brand-color white-text btn-large right" on-click="NLPGet" style="margin-right:12px;">Submit</a>                           
                      </div>
                    </div>
                    <div class="row" id="response_div"></div>
                </div>    
            </div>
          </div> 
        </div>
        <div class="row">
          <div class="card" style="min-height:40vh; position: relative">
            <div class="col s12 center">
                <h3 >Google Vision API</h3>              
                <div class="row">
                  <div class="container">
                    <div class="col s12">
                      <div class="row" style="margin-bottom:20px;">
                        <div class="input-field col s4 right">
                            <button class="waves-effect waves-light green white-text btn-large" id="capture" on-click="startCapture">Capture
                            </button>                           
                        </div>
                        <div class="input-field col s4 left">
                            <button class="waves-effect waves-light red white-text btn-large" id="stop" on-click="stopCapture">Stop
                            </button>                           
                        </div>
                      </div>
                      <video autoplay id="video"></video>
                      <img id="vimg" src="">
                      <p id="b64" style="display:none;"></p>
                      <canvas id="canvas_" style="display:none;" width="640" height="480"></canvas>
                    </div>
                  </div>
                </div>    
            </div>
          </div> 
        </div>
      </div>
    </div>

  </template>
<script src="../scripts/desktop-notify.js"></script>

  <script>
    Polymer({
      is: 'my-labs',
      localMediaStream: null,
      notification: null,
      _dynamicBg: function(){
            var opts = {
              count: 1, //Increases the spawn rate
              size: 50, //Minimal is one
              sizeRandom: 10, //Amount of pixels it can be randomed by
              sparkLife: 0.1, //Decreases the sparks life
              spawnOpacity: 1, //Sparks will spawn at this opacity
            
              //must be RGBA. alpha stands for opacity, usually 1
              color: "rgba(39, 173, 96, alpha)" //The color of sparks.
            },

            canvasBody = this.shadowRoot.querySelector('#canvas'),
            canvas = canvasBody.getContext("2d"),
            w = canvasBody.width = window.innerWidth,
            h = canvasBody.height = window.innerHeight;

            function anim() {
              setTimeout(function() {
                window.requestAnimationFrame(anim)
              }, 1000 / 30 ) //Setting the FPS by dividing the one second by <frames>
              step();
            }

            anim() //Calling the animation function

            function step() {
              var fillColor = opts.color.replace("alpha", opts.spawnOpacity);
              canvas.fillStyle = fillColor;
              for (var i = 0; i < Math.round(opts.count); i++) {
                var random = Math.random() * opts.sizeRandom;
                canvas.fillRect(-(opts.size/2) + Math.random() * w, -(opts.size/2) + Math.random() * h, opts.size + random, opts.size + random)
              }
              canvas.fillStyle = "rgba(255,255,255," + opts.sparkLife + ")"
              canvas.fillRect(0, 0, w, h) 
            }
      },
      componentToHex: function(){
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
      },
      rgbToHex: function(r, g, b) {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
      },
      ready: function(){
        this._dynamicBg();

        video = Polymer.dom(this.root).querySelector('#video');
        canvas_ = Polymer.dom(this.root).querySelector('#canvas_');
        ctx_ = canvas_.getContext('2d');
        this.localMediaStream = null;
        
        navigator.webkitGetUserMedia({video: true}, function(stream) {
          video.src = window.URL.createObjectURL(stream);
          this.localMediaStream = stream;
        }, function(){});


        notify.requestPermission();
        
        this.notification = function(text, body, img){
          notify.createNotification(text, {
            body: body,
            icon: img
          });
        };
        
      },
      NLPGet: function(){
        var value = Polymer.dom(this.root).querySelector('#nlp_input').value;
        var response = Polymer.dom(this.root).querySelector('#response_div');
        if (value != ''){
          $.ajax({
                  url: "https://language.googleapis.com/v1beta1/documents:analyzeEntities?key=AIzaSyDEw3s5ll9c3uFToZjMZSYtUWM0qboy8Vc",
                  type: 'POST',
                  contentType: "application/json; charset=utf-8",
                  data: JSON.stringify({
                    "document":{
                      "type":"PLAIN_TEXT",
                      "content": value
                    },
                    "encodingType":"UTF8"
                  }) 
          }).done(function(data) {
            console.log(data);
            var html = '<h5> The following entities have been detected (language: '+ data.language +'):</h5>';
            for (var i=0, j=data.entities.length; i<j; i++){
              html += '<p style="font-family:roboto-thin">"' + data.entities[i].name + '" interpreted as a ' + data.entities[i].type +' with a relevance among context of ' + data.entities[i].salience +'.</p>';
            }
            console.log(html);
            response.innerHTML = html;

            if (data.language == "en"){
              $.ajax({
                  url: "https://language.googleapis.com/v1beta1/documents:analyzeSentiment?key=AIzaSyDEw3s5ll9c3uFToZjMZSYtUWM0qboy8Vc",
                  type: 'POST',
                  contentType: "application/json; charset=utf-8",
                  data: JSON.stringify({
              "document":{
                "type":"PLAIN_TEXT",
                "content": value
              }
            }) 
              }).done(function(data) {
                console.log(data);
                response.innerHTML += '<p style="font-family:roboto-black"> Sentiment detected has a magnitude of ' + data.documentSentiment.magnitude + ' with polarity of ' + data.documentSentiment.polarity + '.</p>';
              });
              
              $.ajax({
                  url: "https://language.googleapis.com/v1beta1/documents:annotateText?key=AIzaSyDEw3s5ll9c3uFToZjMZSYtUWM0qboy8Vc",
                  type: 'POST',
                  contentType: "application/json; charset=utf-8",
                  data: JSON.stringify({
              "document":{
                "type":"PLAIN_TEXT",
                "content": value
              },
              "features": {
                "extractSyntax": true,
              "extractEntities": true,
              "extractDocumentSentiment": true,
              },
                "encodingType":"UTF8"
            }) 
              }).done(function(data) {
                console.log(data);
                response.innerHTML += '<p style="font-family:roboto-black"> Total sentences: ' + data.sentences.length + '.</p>';
                response.innerHTML += '<p style="font-family:roboto-black"> Total entities: ' + data.entities.length + '.</p>';
              });
            }
          });
        }
          else
                Materialize.toast('<span class="toast-warning">Please add some value to process.</span>',4500);
      },
      startCapture: function(){
        canvas = Polymer.dom(this.root).querySelector('#canvas_');
        ctx = canvas.getContext('2d');
        video = Polymer.dom(this.root).querySelector('#video');
        vimg = Polymer.dom(this.root).querySelector('#vimg');
        b64 = Polymer.dom(this.root).querySelector("#b64");
        msg = Polymer.dom(this.root).querySelector('#msg');
        response = Polymer.dom(this.root).querySelector("#response_div2");
        convertEmotionInfoToNum = function(emotion) {
          return ({
            VERY_UNLIKELY: 0,
            UNLIKELY: 1,
            POSSIBLE: 2,
            LIKELY: 3,
            VERY_LIKELY: 4
          })[emotion]
        };
        pushNotification = function(text, body, img){
          notify.config({
            autoClose: 4000
          });
          this.notification(text,body,img);
        };
        computeVision = function(source){
          console.log('computing vision analysis...')
          var value = b64.innerHTML.split(',')[1];
          $.ajax({
                  url: "https://vision.googleapis.com/v1/images:annotate?key=AIzaSyDJl2LYW2oRn1YuUOL6FHlEpHq0WP4n-3A",
                  type: 'POST',
                  contentType: "application/json; charset=utf-8",
                  data: JSON.stringify({
                    "requests": [{
                  "image":{             
                    "content": value
                  },
                  "features":[
                    {"type": "TYPE_UNSPECIFIED"},
                    {"type": "FACE_DETECTION"},
                    {"type": "LANDMARK_DETECTION"},
                    {"type": "LOGO_DETECTION"},
                    {"type": "LABEL_DETECTION"},
                    {"type": "TEXT_DETECTION"},
                    {"type": "SAFE_SEARCH_DETECTION"},
                    {"type": "IMAGE_PROPERTIES"}
                  // TYPE_UNSPECIFIED Unspecified feature type.
                  // FACE_DETECTION Run face detection.
                  // LANDMARK_DETECTION Run landmark detection.
                  // LOGO_DETECTION Run logo detection.
                  // LABEL_DETECTION  Run label detection.
                  // TEXT_DETECTION Run OCR.
                  // SAFE_SEARCH_DETECTION  Run various computer vision models to compute image safe-search properties.
                  // IMAGE_PROPERTIES Compute a set of properties about the image (such as the image's dominant colors).                
                  ]
                }
              ]
            }) 
              }).done(function(data) {
                if (source == 'from video'){
                  $('#response').hide();
                  if (data.responses[0].faceAnnotations){

                    var dominant_mood = 'poker', max = 0;
                    for (var i=0, j=data.responses[0].faceAnnotations.length; i<j; i++){
                      //data.responses[0].faceAnnotations[i].detectionConfidence;
                      //data.responses[0].faceAnnotations[i].landmarkingConfidence;
                      max = convertEmotionInfoToNum(data.responses[0].faceAnnotations[i].angerLikelihood);
                      dominant_mood = max > 0 ? 'anger' : dominant_mood;
                      //data.responses[0].faceAnnotations[i].blurredLikelihood;
                      //data.responses[0].faceAnnotations[i].headwearLikelihood;
                      dominant_mood = convertEmotionInfoToNum(data.responses[0].faceAnnotations[i].joyLikelihood) > max ? 'joy' : dominant_mood;
                      dominant_mood = convertEmotionInfoToNum(data.responses[0].faceAnnotations[i].sorrowLikelihood) > max ? 'sorrow' : dominant_mood;
                      dominant_mood = convertEmotionInfoToNum(data.responses[0].faceAnnotations[i].surpriseLikelihood) > max ? 'surprise' : dominant_mood;
                      //data.responses[0].faceAnnotations[i].underExposedLikelihood;

                      pushNotification('Face detected !', 'It looks like '+ dominant_mood +' to me...', 'https://mboilerplate.appspot.com/default/materialize/images/moods/face-'+dominant_mood+'.png');
                    }
                  }else{
                    pushNotification('oops !', 'we got no faces', 'none');
                  }
                }
              }).error(function(data) {
                console.log(data);
                
              });
          };
        timer = setInterval(function(){
            if (this.localMediaStream) {
              ctx.drawImage(video, 0, 0);
              vimg.src = canvas.toDataURL('image/jpg');
              b64.innerHTML = canvas.toDataURL('image/jpg');
              computeVision('from video');
            }

        }, 3000);
        var vimg = Polymer.dom(this.root).querySelector('#vimg');
        $(vimg).show();
      },
      stopCapture: function(){
        var vimg = Polymer.dom(this.root).querySelector('#vimg');
        $(vimg).hide();
        clearInterval(timer);
      }

    });
  </script>

</dom-module>
